syntax = "proto3";

package comm.mgr.privilege;

import "protobuf/api/common/common.proto";
import "protobuf/api/privilege/v2/resource_bag.proto";
import "protobuf/api/privilege/v2/resource_package.proto";
import "protobuf/mgr/privilege/resource_package.proto";
import "protobuf/svr/adapter/family.proto";
import "protobuf/api/privilege/v2/privilege.proto";

option go_package = "gitit.cc/social/protobuf/gencode/mgr/pbmprivilege";

// smicro:spath=gitit.cc/social/components-service/social-privilege/biz/resourcebag/handlermgr

// 资源背包接口
// ServiceName: social-privilege
service ResourceBagMgr {
  // --- 资源分配管理相关服务 ---
  // 运营发起资源分配申请
  rpc AllocateResourceBag(AllocateResourceBagReq) returns (AllocateResourceBagRsp);
  // 获取资源分配审核记录列表
  rpc ListResourceBagAllocateAudits(ListResourceBagAllocateAuditsReq) returns (ListResourceBagAllocateAuditsRsp);
  // 审核资源分配申请
  rpc AuditResourceAllocation(AuditResourceAllocationReq) returns (AuditResourceAllocationRsp);
  // 撤回资源分配申请
  rpc WithdrawResourceAllocation(WithdrawResourceAllocationReq) returns (WithdrawResourceAllocationRsp);
  // --- 资源分配管理相关服务 ---


  // --- 特权资源背包相关服务(资源看板) ---
  // 获取资源背包列表
  rpc ListResourceBags(ListResourceBagsReq) returns (ListResourceBagsRsp);
  // 回收特权用户的资源
  rpc ReclaimResourceBag(ReclaimResourceBagReq) returns (ReclaimResourceBagRsp);
  // --- 特权资源背包相关服务 ---


  // --- 发放与扣除记录相关服务 ---
  // 获取资源发放日志列表
  rpc ListResourceBagDistributeLogs(ListResourceBagDistributeLogsReq) returns (ListResourceBagDistributeLogsRsp);
  // 官方扣除已发放的资源
  rpc DeductDistributedResource(DeductDistributedResourceReq) returns (DeductDistributedResourceRsp);
  // 获取资源扣除日志列表
  rpc ListResourceBagDeductLogs(ListResourceBagDeductLogsReq) returns (ListResourceBagDeductLogsRsp);
  // --- 发放与扣除记录相关服务 ---
}

// 特权资源分配审核表
message ResourceBagAllocateAudit {
  int64 id = 1; // 主键

  api.privilege.v2.ResourceBagTargetType target_type = 2; // 拥有者类型(1:用户,2:家族)
  repeated int64 target_ids = 3; // 接收资源拥有者Ids(uid/family_id)

  int64 resource_package_id = 4; // 资源包id
  int64 distribute_deadline = 5; // 资源发放截止时间

  string allocate_reason = 6; // 资源分配原因

  api.privilege.v2.ResourceBagAllocateStatus allocate_status = 7; // 资源分配状态(1:成功,2:失败)
  string allocate_fail_reason = 8; // 发放失败原因

  api.privilege.v2.ResourceBagAuditStatus audit_status = 9; // 审核状态(1:审核中,2:撤回,3:通过,4:拒绝)
  string auditor = 10; // 审核人
  int64 audit_time = 11; // 审核时间
  string audit_remark = 12; // 审核备注

  int64 created_at = 13; // 创建时间
  string creator = 14; // 创建人
  int64 updated_at = 15; // 修改时间
  string updater = 16; // 修改人
  int64 deleted_at = 17; // 删除时间(0:未删除,>0:已删除)
}

// 特权资源背包表
message ResourceBag {
  int64 id = 1; // 主键

  api.privilege.v2.ResourceBagTargetType target_type = 2; // 拥有者类型(1:用户,2:家族)
  int64 target_id = 3; // 拥有者Id(uid/family_id)

  int64 resource_package_id = 4; // 资源包id
  int64 resource_package_detail_id = 5; // 资源包详情id
  api.privilege.v2.ResourceType resource_type = 6; // 资源类型
  int64 resource_id = 7; // 资源id
  api.privilege.v2.EffectType effect_type = 20; // 生效类型

  int64 quantity = 8; // 资源数量
  int64 effective_time = 9; // 有效时间(单位:秒,值<=0:永久)
  int64 distribute_quantity = 10; // 资源已发放数量
  int64 remain_quantity = 19; // 资源剩余数量
  int64 reclaim_quantity = 11; // 资源回收数量

  int64 distribute_deadline = 12; // 资源发放截止时间
  api.privilege.v2.ResourceBagStatus status = 13; // 资源状态(1:正常,2:已过期,3:已回收)

  int64 created_at = 14; // 创建时间(资源分配时间)
  string creator = 15; // 创建人
  int64 updated_at = 16; // 修改时间
  string updater = 17; // 修改人
  int64 deleted_at = 18; // 删除时间(0:未删除,>0:已删除)
}


// 特权资源发放日志
message ResourceBagDistributeLog {
  int64 id = 1; // 主键

  api.privilege.v2.ResourceBagTargetType target_type = 2; // 拥有者类型(1:用户,2:家族)
  int64 target_id = 3; // 拥有者Id(uid/family_id)

  int64 distribute_uid = 4; // 发放资源用户ID
  int64 receive_uid = 5; // 接收资源用户ID

  int64 resource_bag_id = 6; // 特权资源背包id
  int64 resource_package_id = 7; // 资源包id
  int64 resource_package_detail_id = 8; // 资源包详情id
  api.privilege.v2.ResourceType resource_type = 9; // 资源类型
  int64 resource_id = 10; // 资源id
  api.privilege.v2.EffectType effect_type = 27; // 生效类型

  int64 quantity = 11; // 资源发放数量
  int64 effective_time = 12; // 有效时间(单位:秒,值<=0:永久)

  api.privilege.v2.ResourceBagDistributeStatus distribute_status = 13; // 发放状态(1:待发放,2:成功,3:失败,4:部分成功)
  string distribute_status_description = 14; // 发放状态描述
  int64 planned_distribute_time = 15; // 计划发放时间
  int64 actual_distribute_time = 16; // 实际发放时间
  int64 expire_time = 17; // 过期时间

  int64 deduct_quantity = 18; // 资源扣除数量
  int64 deduct_effective_time = 26; // 扣除有效时间(单位:秒)

  api.privilege.v2.ResourceBagDistributeLogDeductStatus deduct_status= 19; // 资源扣除状态(1:未扣除,2:扣除中,3:已扣除,4:失败)

  string remark = 20; // 备注(来源:用户)

  int64 created_at = 21; // 创建时间
  string creator = 22; // 创建人
  int64 updated_at = 23; // 修改时间
  string updater = 24; // 修改人
  int64 deleted_at = 25; // 删除时间(0:未删除,>0:已删除)
}

// 特权资源扣除日志
message ResourceBagDeductLog {
  int64 id = 1; // 主键

  api.privilege.v2.ResourceBagTargetType target_type = 2; // 拥有者类型(1:用户,2:家族)
  int64 target_id = 3; // 拥有者Id(uid/family_id)

  int64 receive_uid = 4; // 接收资源用户ID

  int64 resource_bag_id = 5; // 特权资源背包id
  int64 distribute_log_id = 6; // 特权资源发放日志id
  int64 resource_package_id = 7; // 资源包id
  int64 resource_package_detail_id = 8; // 资源包详情id
  api.privilege.v2.ResourceType resource_type = 9; // 资源类型
  int64 resource_id = 10; // 资源id
  api.privilege.v2.EffectType effect_type = 22; // 生效类型

  int64 expected_quantity = 23; // 期望扣除数量
  int64 expected_effective_time = 24; // 期望扣除有效时间(单位:秒,值<=0:永久)
  int64 quantity = 11; // 资源扣除数量
  int64 effective_time = 12; // 扣除有效时间(单位:秒,值<=0:永久)
  int64 expire_time = 13; // 过期时间

  api.privilege.v2.ResourceBagDeductLogStatus status = 14; // 资源扣除状态(1:初始状态,2:扣除中,3:已扣除,4:失败)
  string status_description = 15; // 状态描述

  string remark = 16; // 备注(来源:oms)

  int64 created_at = 17; // 创建时间
  string creator = 18; // 创建人
  int64 updated_at = 19; // 修改时间
  string updater = 20; // 修改人
  int64 deleted_at = 21; // 删除时间(0:未删除,>0:已删除)
}

enum ResourceBagAllocateAuditSortField {
  RESOURCE_BAG_ALLOCATE_AUDIT_SORT_FIELD_NONE = 0;
  RESOURCE_BAG_ALLOCATE_AUDIT_SORT_FIELD_ID = 1; // 资源包分配审核ID
  RESOURCE_BAG_ALLOCATE_AUDIT_FIELD_UPDATED_AT = 3; // 更新时间
  RESOURCE_BAG_ALLOCATE_AUDIT_FIELD_CREATED_AT = 4; // 创建时间
}

enum ResourceBagSortField {
  RESOURCE_BAG_SORT_FIELD_NONE = 0;
  RESOURCE_BAG_SORT_FIELD_ID = 1; // 资源背包ID
  RESOURCE_BAG_SORT_FIELD_DISTRIBUTE_DEADLINE = 2; // 资源发放截止时间
  RESOURCE_BAG_SORT_FIELD_UPDATED_AT = 3; // 更新时间
  RESOURCE_BAG_SORT_FIELD_CREATED_AT = 4; // 创建时间
}
enum ResourceBagDistributeLogSortField {
  RESOURCE_BAG_DISTRIBUTE_LOG_SORT_FIELD_NONE = 0;
  RESOURCE_BAG_DISTRIBUTE_LOG_SORT_FIELD_ID = 1; // ID
  RESOURCE_BAG_DISTRIBUTE_LOG_SORT_FIELD_UPDATED_AT = 3; // 更新时间
  RESOURCE_BAG_DISTRIBUTE_LOG_SORT_FIELD_CREATED_AT = 4; // 创建时间
}
enum ResourceBagDeductLogSortField {
  RESOURCE_BAG_DEDUCT_LOG_SORT_FIELD_NONE = 0;
  RESOURCE_BAG_DEDUCT_LOG_SORT_FIELD_ID = 1; // ID
  RESOURCE_BAG_DEDUCT_LOG_SORT_FIELD_UPDATED_AT = 3; // 更新时间
  RESOURCE_BAG_DEDUCT_LOG_SORT_FIELD_CREATED_AT = 4; // 创建时间
}

message AllocateResourceBagReq {
  int64 resource_package_id = 1; // 资源包id
  api.privilege.v2.ResourceBagTargetType target_type = 2; // 拥有者类型(1:用户,2:家族)
  repeated int64 target_ids = 3; // 接收资源拥有者Ids(uid/family_id)
  string allocate_reason = 4; // 资源分配原因
  int64 distribute_deadline = 5; // 资源发放截止时间
}
message AllocateResourceBagRsp {
  int64 allocate_audit_id = 1; // 资源分配审核ID
}

message ListResourceBagAllocateAuditsReq {
  scommon.Page page = 1; // 分页参数
  scommon.Sorts sorts = 2; // 排序参数

  int64 allocate_audit_id = 23; // 资源分配审核ID

  api.privilege.v2.ResourceBagTargetType target_type = 10; // 拥有者类型(1:用户,2:家族)
  repeated int64 target_ids = 11; // 接收资源拥有者Ids(uid/family_id)

  int64 created_at_from = 12; // 创建时间->开始时间
  int64 created_at_to = 13; // 创建时间->结束时间

  int64 updated_at_from = 14; // 修改时间->开始时间
  int64 updated_at_to = 15; // 修改时间->结束时间

  int64 distribute_deadline_from = 16; // 资源发放截止时间->开始时间
  int64 distribute_deadline_to = 17; // 资源发放截止时间->结束时间

  int64 resource_package_id = 18; // 资源包id

  string allocate_reason = 19; // 资源分配原因

  string creator = 20; // 创建人

  repeated api.privilege.v2.ResourceBagAllocateStatus allocate_statuses = 21; // 资源分配状态
  repeated api.privilege.v2.ResourceBagAuditStatus audit_statuses = 22; // 审核结果
}
message ListResourceBagAllocateAuditsRsp {
  scommon.Page page = 1; // 分页参数

  repeated ResourceBagAllocateAudit audits = 10;
  map<int64, comm.mgr.privilege.ResourcePackageInfo> resource_packages = 11;  // map<资源包id, 资源包>
}

message AuditResourceAllocationReq {
  int64 allocate_audit_id = 1; // 资源分配审核ID
  api.privilege.v2.ResourceBagAuditStatus audit_status = 2; // 审核结果
  string audit_remark = 3; // 审核备注
}
message AuditResourceAllocationRsp {
  string error_message = 1; // 错误信息
  repeated AllocateTargetFail target_fails = 2;  // 拥有者分配失败
}
message AllocateTargetFail{
  repeated int64 target_ids = 1; // 接收资源拥有者Ids(uid/family_id)
  string fail_reason = 2; // 失败原因
}

message WithdrawResourceAllocationReq {
  int64 allocate_audit_id = 1; // 资源分配审核ID
  string audit_remark = 2; // 审核备注
}
message WithdrawResourceAllocationRsp {
}



message ListResourceBagsReq {
  scommon.Page page = 1; // 分页参数
  scommon.Sorts sorts = 2; // 排序参数

  int64 id = 10; // 资源背包ID

  api.privilege.v2.ResourceBagTargetType target_type = 11; // 拥有者类型(1:用户,2:家族)
  int64 target_id = 12; // 拥有者Id(uid/family_id)

  int64 family_owner_uid = 13; // 家族长uid(拥有者类型为“家族”时有效)
  string family_owner_show_uid = 14; // 家族长show uid(拥有者类型为“家族”时有效)

  int64 resource_package_id = 15; // 资源包id
  repeated api.privilege.v2.ResourceType resource_types = 16; // 资源类型

  api.privilege.v2.ResourceType resource_type = 17; // 资源类型(跟resource_id配合使用)
  int64 resource_id = 18; // 资源id(跟resource_type配合使用)

  int64 distribute_deadline_from = 19; // 资源发放截止时间-开始
  int64 distribute_deadline_to = 20; // 资源发放截止时间-结束

  int64 created_at_from = 21; // 创建时间(资源分配时间)-开始
  int64 created_at_to = 22; // 创建时间(资源分配时间)-结束

  repeated api.privilege.v2.ResourceBagStatus statuses = 23; // 资源状态(1:正常,2:已过期,3:已回收)

  string creator = 24; // 创建人
  string updater = 25; // 修改人
}
message ListResourceBagsRsp {
  scommon.Page page = 1; // 分页参数

  repeated ResourceBag bags = 10;
  map<int64, comm.mgr.privilege.ResourcePackageInfo> resource_package_infos = 11;  // map<资源包id, 资源包>
  map<int64, api.privilege.v2.ResourcePackageDetailInfo> resource_package_detail_infos = 12;  // map<资源包详情id, 资源包详情>
  map<int64, pbsadapter.FamilyInfo> family_infos = 13;  // map<familyId, 家族信息>
  map<int64, api.privilege.v2.Resource> resources = 14; // map<特权资源id, 特权资源>
}

message ReclaimResourceBagReq {
  int64 resource_bag_id = 1; // 资源背包ID
}
message ReclaimResourceBagRsp {
}

message ListResourceBagDistributeLogsReq {
  scommon.Page page = 1; // 分页参数
  scommon.Sorts sorts = 2; // 排序参数

  int64 id = 10; // 发放日志 ID

  api.privilege.v2.ResourceBagTargetType target_type = 11; // 拥有者类型(1:用户,2:家族)
  int64 target_id = 12; // 拥有者Id(uid/family_id)

  int64 family_owner_uid = 13; // 家族长uid(拥有者类型为“家族”时有效)
  string family_owner_show_uid = 14; // 家族长show uid(拥有者类型为“家族”时有效)

  int64 receive_uid = 15; // 接收资源用户ID
  string receive_show_uid = 16; // 接收资源用户show ID

  int64 resource_package_id = 17; // 资源包id
  repeated api.privilege.v2.ResourceType resource_types = 18; // 资源类型

  api.privilege.v2.ResourceType resource_type = 19; // 资源类型(跟resource_id配合使用)
  int64 resource_id = 20; // 资源id(跟resource_type配合使用)

  api.privilege.v2.ResourceBagDistributeStatus  distribute_status = 21; // 发放状态

  int64 planned_distribute_time_from = 22; // 计划发放时间-开始
  int64 planned_distribute_time_to = 23; // 计划发放时间-结束
  int64 actual_distribute_time_from = 24; // 实际发放时间-开始
  int64 actual_distribute_time_to = 25; // 实际发放时间-结束

  api.privilege.v2.ResourceBagDistributeLogDeductStatus deduct_status= 26; // 资源扣除状态(1:未扣除,2:扣除中,3:已扣除,4:失败)
}
message ListResourceBagDistributeLogsRsp {
  scommon.Page page = 1; // 分页参数

  repeated ResourceBagDistributeLog logs = 10;
  map<int64, comm.mgr.privilege.ResourcePackageInfo> resource_package_infos = 11;  // map<资源包id, 资源包>
  map<int64, api.privilege.v2.ResourcePackageDetailInfo> resource_package_detail_infos = 12;  // map<资源包详情id, 资源包详情>
  map<int64, pbsadapter.FamilyInfo> family_infos = 13;  // map<familyId, 家族信息>
}

message DeductDistributedResourceReq {
  int64 distribute_log_id = 1; // 发放记录ID
  string remark = 3; // 备注
}
message DeductDistributedResourceRsp {
  int64 deduct_log_id = 1; // 扣除记录id
	int64 deduct_amount =2; // 实际扣减数量
	int64 deduct_effective_time_secs =3; // 实际扣除有效时间(秒)
	bool success =4; // 是否成功
	repeated string messages =5; // 失败时的错误信息（可选）
}

message ListResourceBagDeductLogsReq {
  scommon.Page page = 1; // 分页参数
  scommon.Sorts sorts = 2; // 排序参数

  int64 id = 10; // 扣除日志 ID

  api.privilege.v2.ResourceBagTargetType target_type = 11; // 拥有者类型(1:用户,2:家族)
  int64 target_id = 12; // 拥有者Id(uid/family_id)

  int64 family_owner_uid = 13; // 家族长uid(拥有者类型为“家族”时有效)
  string family_owner_show_uid = 14; // 家族长show uid(拥有者类型为“家族”时有效)

  int64 receive_uid = 15; // 接收资源用户ID
  string receive_show_uid = 16; // 接收资源用户ID

  int64 resource_package_id = 17; // 资源包id
  repeated api.privilege.v2.ResourceType resource_types = 18; // 资源类型

  api.privilege.v2.ResourceType resource_type = 19; // 资源类型(跟resource_id配合使用)
  int64 resource_id = 20; // 资源id(跟resource_type配合使用)

  int64 created_at_from = 21; // 创建时间-开始
  int64 created_at_to = 22; // 创建时间-结束
  string creator = 23; // 操作人
}
message ListResourceBagDeductLogsRsp {
  scommon.Page page = 1; // 分页参数

  repeated ResourceBagDeductLog logs = 10;
  map<int64, comm.mgr.privilege.ResourcePackageInfo> resource_package_infos = 11;  // map<资源包id, 资源包>
  map<int64, api.privilege.v2.ResourcePackageDetailInfo> resource_package_detail_infos = 12;  // map<资源包详情id, 资源包详情>
  map<int64, pbsadapter.FamilyInfo> family_infos = 13;  // map<familyId, 家族信息>
}

